<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gerenciar Carreiras - Counter Strike GM</title>
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <link
      rel="shortcut icon"
      href="assets/img/favicon/favicon.jpg"
      type="image/x-icon"
    />
    <style>
      .dropdown {
        position: relative;
      }
      .dropdown-menu {
        display: none;
        position: absolute;
        right: 0;
        top: 110%;
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        min-width: 140px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        z-index: 1000;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.15s;
        min-width: 140px;
        max-width: 90vw; /* evita overflow em telas muito pequenas */
        box-sizing: border-box;
        visibility: hidden; /* controlado pelo JS */
        min-width: 120px; /* um pouco menor */
        max-width: 160px; /* evita ficar muito largo */
        padding: 0.25rem 0; /* menos espaço vertical */
        font-size: 0.875rem; /* texto um pouco menor */
        text-align: center; /* centraliza texto */
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
      }
      .dropdown.open .dropdown-menu {
        display: block;
        opacity: 1;
        pointer-events: auto;
      }
      .dropdown-menu button {
        width: 100%;
        text-align: left;
        padding: 0.5rem 1rem;
        background: none;
        border: none;
        cursor: pointer;
        font-size: 0.95rem;
      }
      .dropdown-menu button:hover {
        background: #f3f4f6;
      }
      .dropdown .dropdown-menu {
        visibility: hidden;
      }
      .dropdown.open .dropdown-menu {
        visibility: visible;
      }
    </style>
  </head>
  <body class="bg-gray-100 text-gray-800 min-h-screen">
    
    <main class="max-w-5xl mx-auto mt-10">
      <div class="flex items-center justify-between mb-6">
        <h1 class="text-2xl font-bold">Gerenciar Carreiras</h1>
        <button
          id="btn-nova-carreira"
          class="bg-blue-600 text-white px-6 py-2 rounded font-semibold hover:bg-blue-700 transition"
        >
          Nova carreira
        </button>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full bg-white rounded shadow border border-gray-200">
          <thead>
            <tr class="text-left border-b">
              <th class="py-2 px-3"></th>
              <th class="py-2 px-3">Nome</th>
              <th class="py-2 px-3">Time</th>
              <th class="py-2 px-3">Criado</th>
              <th class="py-2 px-3">Última jogada</th>
              <th class="py-2 px-3"></th>
            </tr>
          </thead>
          <tbody id="tbody-carreiras"></tbody>
        </table>
      </div>
    </main>
    <input type="file" id="input-importar-save" accept=".json" class="hidden" />
    <script src="assets/js/main.js"></script>
    <script>
      // Utilidades de data
      function formatarData(timestamp) {
        if (!timestamp) return "-";
        const d = new Date(timestamp);
        return (
          d.toLocaleDateString("pt-BR") +
          " " +
          d.toLocaleTimeString("pt-BR", { hour: "2-digit", minute: "2-digit" })
        );
      }
      function tempoRelativo(timestamp) {
        if (!timestamp) return "-";
        const diff = Math.floor((Date.now() - timestamp) / 1000);
        if (diff < 60) return "agora mesmo";
        if (diff < 3600) return Math.floor(diff / 60) + " min atrás";
        if (diff < 86400) return Math.floor(diff / 3600) + "h atrás";
        if (diff < 604800) return Math.floor(diff / 86400) + "d atrás";
        return formatarData(timestamp);
      }

      // --- NOVO SISTEMA DE SAVES ---
      function getCarreiras() {
        return JSON.parse(localStorage.getItem("carreiras") || "[]");
      }
      function setCarreiras(carreiras) {
        localStorage.setItem("carreiras", JSON.stringify(carreiras));
      }
      function salvarCarreiraAtual(nome) {
        const save = {};
        for (let i = 0; i < localStorage.length; i++) {
          const k = localStorage.key(i);
          if (k === "carreiras") continue;
          try {
            save[k] = JSON.parse(localStorage.getItem(k));
          } catch {
            save[k] = localStorage.getItem(k);
          }
        }
        let carreiras = getCarreiras();
        const idx = carreiras.findIndex((c) => c.nome === nome);
        if (idx >= 0) {
          carreiras[idx].save = save;
          carreiras[idx].lastPlayed = Date.now();
        } else {
          carreiras.push({ nome, save, lastPlayed: Date.now() });
        }
        setCarreiras(carreiras);
      }
      function carregarCarreira(nome) {
        const carreiras = getCarreiras();
        const carreira = carreiras.find((c) => c.nome === nome);
        if (!carreira) return false;
        Object.keys(localStorage).forEach((k) => {
          if (k !== "carreiras") localStorage.removeItem(k);
        });
        Object.keys(carreira.save).forEach((k) =>
          localStorage.setItem(k, JSON.stringify(carreira.save[k]))
        );
        localStorage.setItem("carreiraAtiva", nome);
        return true;
      }
      function getCarreiraAtiva() {
        return localStorage.getItem("carreiraAtiva") || "";
      }

      function restoreMovedDropdowns() {
        // pega menus que foram movidos para o body
        document.querySelectorAll("body > .dropdown-menu").forEach((menu) => {
          // se o menu tem referência ao parent original, restaura
          if (menu._origParent) {
            // reset visual
            menu.style.display = "";
            menu.style.position = "";
            menu.style.top = "";
            menu.style.left = "";
            menu.style.zIndex = "";
            menu.style.pointerEvents = "";
            menu.style.opacity = "";
            menu.style.visibility = "hidden";

            // coloca de volta no local original (antes do sibling que existia)
            if (menu._origNext)
              menu._origParent.insertBefore(menu, menu._origNext);
            else menu._origParent.appendChild(menu);

            // remove classe open caso ainda exista em algum pai
            const maybeDrop = menu._origParent.closest
              ? menu._origParent.closest(".dropdown")
              : null;
            if (maybeDrop) maybeDrop.classList.remove("open");
          } else {
            // limpeza: se não tem parent original, remove para evitar lixo
            menu.remove();
          }
        });

        // também fecha quaisquer dropdowns marcados como open no DOM atual
        document
          .querySelectorAll(".dropdown.open")
          .forEach((d) => d.classList.remove("open"));
      }

      // chama a restauração antes de re-render
      restoreMovedDropdowns();

      // Renderiza tabela de carreiras
      function renderTabelaCarreiras() {
        restoreMovedDropdowns();

        const tbody = document.getElementById("tbody-carreiras");
        tbody.innerHTML = "";
        let carreiras = getCarreiras();
        if (!carreiras.length) {
          tbody.innerHTML = `<tr><td colspan="6" class="text-center text-gray-500 py-8">Nenhuma carreira salva.</td></tr>`;
          return;
        }
        carreiras
          .sort((a, b) => (b.lastPlayed || 0) - (a.lastPlayed || 0))
          .forEach((c) => {
            const tr = document.createElement("tr");
            tr.className = "border-b hover:bg-gray-50";
            // Botão Jogar
            const tdPlay = document.createElement("td");
            tdPlay.className = "py-2 px-3";
            const btnPlay = document.createElement("button");
            btnPlay.textContent = "Jogar";
            btnPlay.className =
              "bg-green-600 text-white px-4 py-1 rounded font-semibold hover:bg-green-700 transition";
            btnPlay.onclick = () => {
              const ativa = getCarreiraAtiva();
              if (ativa) salvarCarreiraAtual(ativa);
              carregarCarreira(c.nome);
              setTimeout(() => {
                window.location.href = "index.html";
              }, 100);
            };
            tdPlay.appendChild(btnPlay);

            // Nome da carreira
            const tdNome = document.createElement("td");
            tdNome.className = "py-2 px-3";
            tdNome.innerHTML = `<span class="font-semibold">${c.nome}</span>${
              c.nome === getCarreiraAtiva()
                ? ' <span class="text-xs text-blue-600">(ativa)</span>'
                : ""
            }`;

            // Time escolhido
            const tdTime = document.createElement("td");
            tdTime.className = "py-2 px-3";
            let time =
              c.save && c.save.timeSelecionado
                ? c.save.timeSelecionado.replace(/</g, "&lt;")
                : "-";
            tdTime.innerHTML = `<span>${time}</span>`;

            // Criado
            const tdCriado = document.createElement("td");
            tdCriado.className = "py-2 px-3";
            tdCriado.textContent = formatarData(
              c.save && c.save.criado ? c.save.criado : c.lastPlayed
            );

            // Última jogada
            const tdUltima = document.createElement("td");
            tdUltima.className = "py-2 px-3";
            tdUltima.textContent = tempoRelativo(c.lastPlayed);

            // Menu de ações
            const tdAcoes = document.createElement("td");
            tdAcoes.className = "py-2 px-3";
            tdAcoes.innerHTML = `
            <div class="dropdown inline-block ">
              <button class="text-gray-600 hover:bg-gray-200 rounded-full p-2" title="Mais ações" tabindex="0">&#8942;</button>
              <div class="dropdown-menu overflow-hidden">
                <button data-export="${c.nome}">Exportar</button>
                <button data-renomear="${c.nome}">Renomear</button>
                <button data-clonar="${c.nome}">Clonar</button>
                <button data-deletar="${c.nome}" class="text-red-600">Deletar</button>
              </div>
            </div>
          `;

            tr.appendChild(tdPlay);
            tr.appendChild(tdNome);
            tr.appendChild(tdTime);
            tr.appendChild(tdCriado);
            tr.appendChild(tdUltima);
            tr.appendChild(tdAcoes);
            tbody.appendChild(tr);
          });

        function positionMenuForDrop(drop, menu) {
          const btn = drop.querySelector("button[title]");
          const rect = btn.getBoundingClientRect();

          // deixa visível temporariamente para medir
          menu.style.display = "block";
          menu.style.position = "fixed";
          menu.style.zIndex = 9999;
          menu.style.visibility = "visible";
          menu.style.pointerEvents = "auto";
          menu.style.opacity = 1;

          const mRect = menu.getBoundingClientRect();
          let top = rect.bottom + 8;
          // se não couber embaixo, posiciona acima
          if (top + mRect.height > window.innerHeight - 8) {
            top = rect.top - mRect.height - 8;
          }

          let left = rect.right - mRect.width;
          if (left < 8) left = rect.left;
          if (left + mRect.width > window.innerWidth - 8) {
            left = window.innerWidth - mRect.width - 8;
          }

          menu.style.top = top + "px";
          menu.style.left = left + "px";
        }

        function openDrop(drop) {
          const menu = drop.querySelector(".dropdown-menu");
          if (!menu) return;
          // guarda referência ao local original (para restaurar depois)
          if (!menu._origParent) {
            menu._origParent = menu.parentNode;
            menu._origNext = menu.nextSibling;
          }
          document.body.appendChild(menu); // remove do container que tem overflow
          positionMenuForDrop(drop, menu);
          drop.classList.add("open");
          drop._movedMenu = menu;
        }

        function closeDrop(drop) {
          drop.classList.remove("open");
          const menu = drop._movedMenu || drop.querySelector(".dropdown-menu");
          if (!menu) return;
          // reset styles
          menu.style.display = "";
          menu.style.position = "";
          menu.style.top = "";
          menu.style.left = "";
          menu.style.zIndex = "";
          menu.style.pointerEvents = "";
          menu.style.opacity = "";
          menu.style.visibility = "hidden";
          // volta para o local original na tabela
          if (menu._origParent) {
            if (menu._origNext)
              menu._origParent.insertBefore(menu, menu._origNext);
            else menu._origParent.appendChild(menu);
          }
          delete drop._movedMenu;
        }

        // conecta botões dos dropdowns
        document.querySelectorAll(".dropdown").forEach((drop) => {
          const btn = drop.querySelector("button[title]");
          btn.onclick = function (e) {
            e.stopPropagation();
            // fecha os outros
            document.querySelectorAll(".dropdown.open").forEach((d) => {
              if (d !== drop) closeDrop(d);
            });
            if (drop.classList.contains("open")) closeDrop(drop);
            else openDrop(drop);
          };
        });

        // fecha tudo ao clicar fora (só adiciona uma vez)
        if (!window._carreirasDropdownInit) {
          document.addEventListener("click", () => {
            document
              .querySelectorAll(".dropdown.open")
              .forEach((d) => closeDrop(d));
          });
          // reposiciona menus abertos no resize/scroll
          window.addEventListener("resize", () => {
            document.querySelectorAll(".dropdown.open").forEach((d) => {
              if (d._movedMenu) positionMenuForDrop(d, d._movedMenu);
            });
          });
          window.addEventListener(
            "scroll",
            () => {
              document.querySelectorAll(".dropdown.open").forEach((d) => {
                if (d._movedMenu) positionMenuForDrop(d, d._movedMenu);
              });
            },
            true
          );
          window._carreirasDropdownInit = true;
        }

        // Exportar
        tbody.querySelectorAll("[data-export]").forEach((btn) => {
          btn.onclick = (e) => {
            e.stopPropagation();
            document
              .querySelectorAll(".dropdown.open")
              .forEach((d) => d.classList.remove("open"));
            const nome = btn.getAttribute("data-export");
            const carreiras = getCarreiras();
            const carreira = carreiras.find((c) => c.nome === nome);
            if (!carreira) return;
            const blob = new Blob(
              [
                JSON.stringify(
                  { nome: carreira.nome, save: carreira.save },
                  null,
                  2
                ),
              ],
              { type: "application/json" }
            );
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = `cs-gm-save-${carreira.nome}.json`;
            a.click();
          };
        });

        // Renomear
        tbody.querySelectorAll("[data-renomear]").forEach((btn) => {
          btn.onclick = (e) => {
            e.stopPropagation();
            document
              .querySelectorAll(".dropdown.open")
              .forEach((d) => d.classList.remove("open"));
            const nome = btn.getAttribute("data-renomear");
            let novoNome = prompt("Novo nome para a carreira:", nome);
            if (!novoNome || novoNome === nome) return;
            novoNome = novoNome.trim();
            let carreiras = getCarreiras();
            if (carreiras.some((c) => c.nome === novoNome)) {
              alert("Já existe uma carreira com esse nome.");
              return;
            }
            const idx = carreiras.findIndex((c) => c.nome === nome);
            if (idx >= 0) {
              carreiras[idx].nome = novoNome;
              setCarreiras(carreiras);
              if (getCarreiraAtiva() === nome)
                localStorage.setItem("carreiraAtiva", novoNome);
              renderTabelaCarreiras();
            }
          };
        });

        // Clonar
        tbody.querySelectorAll("[data-clonar]").forEach((btn) => {
          btn.onclick = (e) => {
            e.stopPropagation();
            document
              .querySelectorAll(".dropdown.open")
              .forEach((d) => d.classList.remove("open"));

            const nome = btn.getAttribute("data-clonar");
            let carreiras = getCarreiras();
            const carreira = carreiras.find((c) => c.nome === nome);
            if (!carreira) return;
            let novoNome = prompt("Nome para a cópia:", nome + " (Cópia)");
            if (!novoNome) return;
            novoNome = novoNome.trim();
            if (carreiras.some((c) => c.nome === novoNome)) {
              alert("Já existe uma carreira com esse nome.");
              return;
            }
            carreiras.push({
              nome: novoNome,
              save: JSON.parse(JSON.stringify(carreira.save)),
              lastPlayed: Date.now(),
            });
            setCarreiras(carreiras);
            renderTabelaCarreiras();
          };
        });

        // Deletar
        tbody.querySelectorAll("[data-deletar]").forEach((btn) => {
          btn.onclick = (e) => {
            e.stopPropagation();
            document
              .querySelectorAll(".dropdown.open")
              .forEach((d) => d.classList.remove("open"));
            const nome = btn.getAttribute("data-deletar");
            if (!confirm("Deseja realmente excluir esta carreira?")) return;
            let carreiras = getCarreiras().filter((c) => c.nome !== nome);
            setCarreiras(carreiras);
            if (getCarreiraAtiva() === nome) {
              localStorage.removeItem("carreiraAtiva");
              localStorage.removeItem("timeSelecionado");
              localStorage.removeItem("elenco");
              localStorage.removeItem("mercado");
            }
            renderTabelaCarreiras();
          };
        });
      }

      // Nova carreira
      document.getElementById("btn-nova-carreira").onclick = () => {
        let nome = prompt("Digite um nome para sua nova carreira:");
        if (!nome) return;
        nome = nome.trim();
        if (!nome) return;
        let carreiras = getCarreiras();
        if (carreiras.some((c) => c.nome === nome)) {
          alert("Já existe uma carreira com esse nome.");
          return;
        }
        Object.keys(localStorage).forEach((k) => {
          if (k !== "carreiras") localStorage.removeItem(k);
        });
        localStorage.setItem("carreiraAtiva", nome);
        localStorage.setItem("criado", Date.now());
        window.location.href = "index.html?newcareer=1";
      };

      document.getElementById("input-importar-save").onchange = function (e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function (evt) {
          try {
            const data = JSON.parse(evt.target.result);
            if (!data.nome || !data.save) throw "Save inválido";
            let carreiras = getCarreiras();
            if (carreiras.some((c) => c.nome === data.nome)) {
              if (
                !confirm("Já existe uma carreira com esse nome. Sobrescrever?")
              )
                return;
              carreiras = carreiras.filter((c) => c.nome !== data.nome);
            }
            carreiras.push({
              nome: data.nome,
              save: data.save,
              lastPlayed: Date.now(),
            });
            setCarreiras(carreiras);
            alert("Carreira importada com sucesso!");
            renderTabelaCarreiras();
          } catch {
            alert("Arquivo de save inválido.");
          }
        };
        reader.readAsText(file);
      };

      renderTabelaCarreiras();
    </script>
  </body>
</html>
